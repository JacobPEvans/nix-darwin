# Pre-commit hooks for nix-darwin configuration
#
# Hooks run automatically via core.hooksPath (set in common.nix)
# Run manually: pre-commit run --all-files

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
        args: ["--maxkb=500"]
      - id: check-merge-conflict
      - id: detect-private-key

  # Markdown linting (using markdownlint-cli2 which reads .markdownlint-cli2.jsonc)
  # Config file has "fix: true" to auto-fix issues
  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.18.1
    hooks:
      - id: markdownlint-cli2
        files: \.md$

  # Local hooks using system-installed tools (from nix)
  - repo: local
    hooks:
      # Nix quality checks - DRY with GitHub Actions via flake checks
      # Single source of truth: checks defined in flake.nix
      # Runs: formatting (nixfmt-rfc-style), linting (statix), dead code (deadnix)
      - id: nix-flake-check
        name: Nix quality checks (format + lint + deadnix)
        entry: nix flake check --no-build --print-build-logs
        language: system
        files: \.nix$
        types: [file]
        exclude: ^worktrees/
        pass_filenames: false

      # Claude Code settings validation - check-jsonschema installed via nix
      - id: validate-claude-settings
        name: Validate Claude settings
        entry: check-jsonschema --schemafile https://json.schemastore.org/claude-code-settings.json
        language: system
        files: '\.claude/settings(\.local)?\.json$'
        types: [json]

      # File size check - DRY with GitHub Actions via shared script
      # Blocks at 12KB hard limit, warns at 6KB recommended
      # Extended (32KB): CLAUDE, ANTHROPIC-ECOSYSTEM, TROUBLESHOOTING
      # Exempt (no limit): RUNBOOK, *-permissions-*.nix files
      - id: file-size-check
        name: File size check (6KB warn, 12KB fail)
        entry: scripts/workflows/check-file-sizes.sh
        args:
          - "CLAUDE ANTHROPIC-ECOSYSTEM TROUBLESHOOTING"
          - "RUNBOOK copilot-permissions-allow copilot-permissions-ask copilot-permissions-deny gemini-permissions-allow gemini-permissions-deny"
        language: system
        files: \.(md|nix)$
        types: [file]
        pass_filenames: false

      # Auto-Claude shell script validation
      # Validates syntax of all auto-claude shell scripts
      - id: validate-auto-claude-scripts
        name: Validate auto-claude shell scripts
        entry: bash -c 'shopt -s nullglob; rc=0; for f in modules/home-manager/ai-cli/claude/auto-claude*.sh; do zsh -n "$f" || rc=1; done; exit $rc'
        language: system
        files: '^modules/home-manager/ai-cli/claude/auto-claude.*\.sh$'
        types: [file]
        pass_filenames: false

      # Orchestrator prompt validation
      # Ensures prompt file exists and contains required sections
      - id: validate-orchestrator-prompt
        name: Validate orchestrator prompt
        entry: bash -c 'f="modules/home-manager/ai-cli/claude/orchestrator-prompt.txt"; test -s "$f" && grep -q "CORE LOOP" "$f" && grep -q "IDENTITY" "$f"'
        language: system
        files: '^modules/home-manager/ai-cli/claude/orchestrator-prompt\.txt$'
        types: [file]
        pass_filenames: false

      # Flake input updates - run on .nix file changes
      # Updates critical inputs to stay current with upstream
      - id: update-flake-inputs
        name: Update flake inputs (nixpkgs, ai-assistant-instructions, agent-os, nix-config-main)
        entry: nix flake lock --update-input nixpkgs --update-input ai-assistant-instructions --update-input agent-os --update-input nix-config-main
        language: system
        files: \.nix$
        types: [file]
        pass_filenames: false
