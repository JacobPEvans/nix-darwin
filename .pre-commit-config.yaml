# Pre-commit hooks for nix-darwin configuration
#
# Hooks run automatically via core.hooksPath (set in common.nix)
# Run manually: pre-commit run --all-files
#
# PARALLELIZATION:
# - Pre-commit runs hooks in parallel by default (one thread per hook)
# - All hooks in this config run automatically on every commit (no manual stages)
# - Early issue detection outweighs any slowdown from network/IO operations
# - AI agents should not be relied upon to remember manual hook stages

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
        args: ["--maxkb=500"]
      - id: check-merge-conflict
      - id: detect-private-key

  # Markdown linting (using markdownlint-cli2 which reads .markdownlint-cli2.jsonc)
  # Config file has "fix: true" to auto-fix issues
  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.20.0
    hooks:
      - id: markdownlint-cli2
        files: \.md$

  # GitHub Actions security scanner - zizmor
  # Detects: excessive permissions, template injection, credential leakage,
  # dangerous triggers, and 25+ other security issues
  # Uses 'regular' persona (excludes pedantic checks like unpinned-uses)
  # Config: .github/zizmor.yml for rule customization
  # See: https://docs.zizmor.sh/audits/
  - repo: https://github.com/zizmorcore/zizmor-pre-commit
    rev: v1.22.0
    hooks:
      - id: zizmor
        args: ['--persona=regular', '--min-severity=medium', '--min-confidence=medium']

  # Python/JS/Go security scanner - semgrep
  # Detects: injection vulnerabilities, hardcoded secrets, insecure patterns
  # Runs security-audit rules on all supported languages
  # See: https://semgrep.dev/docs/extensions/pre-commit
  - repo: https://github.com/semgrep/pre-commit
    rev: v1.149.0
    hooks:
      - id: semgrep
        args: ['--config', 'p/security-audit', '--skip-unknown-extensions']

  # Local hooks using system-installed tools (from nix)
  - repo: local
    hooks:
      # Nix formatting check - nixfmt-rfc-style
      - id: nix-fmt-check
        name: Nix formatting (nixfmt-rfc-style)
        entry: "bash -c 'nixfmt --check \"$@\" || (echo \"Run: nix fmt\"; exit 1)' --"
        language: system
        files: \.nix$
        types: [file]
        exclude: ^worktrees/

      # Nix linting - statix (catches anti-patterns and code smells)
      # CRITICAL: This MUST run and block commits - no --no-build shortcuts
      - id: nix-statix
        name: Nix linting (statix)
        entry: statix check
        language: system
        files: \.nix$
        types: [file]
        exclude: ^worktrees/
        pass_filenames: false

      # Nix dead code detection - deadnix
      - id: nix-deadnix
        name: Nix dead code (deadnix)
        entry: deadnix -L --fail
        language: system
        files: \.nix$
        types: [file]
        exclude: ^worktrees/
        pass_filenames: false

      # Claude Code settings validation - check-jsonschema via nix shell
      - id: validate-claude-settings
        name: Validate Claude settings
        entry: nix shell nixpkgs#check-jsonschema -c check-jsonschema --schemafile https://json.schemastore.org/claude-code-settings.json
        language: system
        files: '\.claude/settings(\.local)?\.json$'
        types: [json]

      # Validate no double-wildcard patterns in permissions
      # Prevents :*:* patterns that result from incorrect source format
      # Uses default configuration if specific host is not available
      - id: validate-permission-wildcards
        name: Check for invalid :*:* permission patterns
        entry: >
          bash -c 'nix eval --json ".#darwinConfigurations.default.config.home-manager.users.\${HM_USER:-\${USER}}.programs.claude.settings.permissions" 2>/dev/null | grep -q ":\*:\*" && echo "ERROR: Found :*:* pattern in permissions. Source files should not have :* suffix." && exit 1 || exit 0'
        language: system
        files: 'modules/home-manager/ai-cli/(common/(formatters|permissions)|claude-config)\.nix$'
        types: [file]
        pass_filenames: false

      # File size check - DRY with GitHub Actions via shared config
      # Config: scripts/workflows/file-size-config.sh (single source of truth)
      # Limits: 6KB recommended, 12KB hard, 32KB extended
      - id: file-size-check
        name: File size check (6KB warn, 12KB fail)
        entry: scripts/workflows/check-file-sizes.sh
        language: system
        files: \.(md|nix)$
        types: [file]
        pass_filenames: false

      # Lychee link checker - validates links in markdown and HTML
      # Runs automatically on every commit (not manual-stage)
      # Lychee is fast with async validation and caching, minimal slowdown impact
      - id: lychee
        name: Lychee link checker
        entry: lychee
        language: system
        files: \.(md|html)$
        types: [file]
        pass_filenames: true

      # Auto-Claude shell script validation
      # Validates syntax of all auto-claude shell scripts
      - id: validate-auto-claude-scripts
        name: Validate auto-claude shell scripts
        entry: bash -c 'find modules/home-manager/ai-cli/claude -name "auto-claude*.sh" -exec zsh -n {} \; || exit 1'
        language: system
        files: '^modules/home-manager/ai-cli/claude/auto-claude.*\.sh$'
        types: [file]
        pass_filenames: false

      # Orchestrator prompt validation
      # Ensures prompt file exists and contains required sections
      - id: validate-orchestrator-prompt
        name: Validate orchestrator prompt
        entry: bash -c 'f="modules/home-manager/ai-cli/claude/orchestrator-prompt.txt"; test -s "$f" && grep -q "CORE LOOP" "$f" && grep -q "IDENTITY" "$f"'
        language: system
        files: '^modules/home-manager/ai-cli/claude/orchestrator-prompt\.txt$'
        types: [file]
        pass_filenames: false

      # NPM package URL validation
      # Validates that npm package URLs in ai-tools.nix actually exist (no 404s)
      - id: validate-npm-urls
        name: Validate npm package URLs
        entry: scripts/validate-npm-urls.sh
        language: system
        files: '^modules/home-manager/ai-cli/ai-tools\.nix$'
        types: [file]
        pass_filenames: false

      # Homebrew package hierarchy validation
      # HARD FAIL if any npm/bunx packages are available in homebrew
      # Enforces: nixpkgs → homebrew → bun → npm → bunx
      - id: validate-brew-before-npm
        name: Check homebrew before npm/bunx (hierarchy)
        entry: scripts/validate-brew-before-npm.sh
        language: system
        files: '^modules/home-manager/ai-cli/ai-tools\.nix$'
        types: [file]
        pass_filenames: false

      # Nixpkgs package hierarchy validation
      # HARD FAIL if any homebrew packages are available in nixpkgs
      # Enforces: nixpkgs → homebrew → bun → npm → bunx
      - id: validate-nix-before-all
        name: Check nixpkgs before all others (hierarchy)
        entry: scripts/validate-nix-before-all.sh
        language: system
        files: '^modules/darwin/homebrew\.nix$'
        types: [file]
        pass_filenames: false

      # Package freshness validation
      # HARD FAIL if packages are too old (prevents security issues)
      # Critical packages: <30 days, All packages: <90 days
      - id: validate-package-freshness
        name: Validate package freshness (staleness check)
        entry: scripts/validate-package-freshness.sh
        language: system
        files: '^flake\.lock$'
        types: [file]
        pass_filenames: false

      # Flake input updates - run manually to update critical inputs
      # Use: pre-commit run --hook-stage manual update-flake-inputs
      - id: update-flake-inputs
        name: Update flake inputs (nixpkgs, ai-assistant-instructions, agent-os, nix-config-main)
        entry: nix flake update nixpkgs ai-assistant-instructions agent-os nix-config-main
        language: system
        stages: [manual]
        pass_filenames: false
