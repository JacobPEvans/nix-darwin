# Nix CI - Validate flake configuration
#
# Uses Determinate Systems actions for fast, reliable Nix CI:
# - determinate-nix-action: Installs Nix with determinacy (pure eval, etc.)
# - flakehub-cache-action: Binary cache for fast builds via FlakeHub
# - flake-checker-action: Validate flake.lock health (nixpkgs freshness)
#
# References:
# - https://github.com/DeterminateSystems/determinate-nix-action
# - https://github.com/DeterminateSystems/flakehub-cache-action
# - https://github.com/DeterminateSystems/flake-checker-action

name: Nix CI

on:
  push:
    branches: [main]
    paths:
      - '**.nix'
      - 'flake.lock'
  pull_request:
    paths:
      - '**.nix'
      - 'flake.lock'

jobs:
  check:
    name: Validate Flake
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for FlakeHub OIDC authentication
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Enable FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@v2
        with:
          use-gha-cache: disabled  # FlakeHub only - no GitHub Actions cache

      - name: Check flake.lock health
        uses: DeterminateSystems/flake-checker-action@main
        with:
          # Warn if nixpkgs is older than 30 days
          nixpkgs-keys: nixpkgs

      - name: Validate flake
        run: nix flake check --no-build

  format:
    name: Check Formatting
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for FlakeHub OIDC authentication
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Enable FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@v2
        with:
          use-gha-cache: disabled  # FlakeHub only - no GitHub Actions cache

      - name: Check Nix formatting
        run: |
          # Find all .nix files and check formatting
          # Using nixfmt-classic (available in nixpkgs)
          nix-shell -p nixfmt-classic --run 'find . -name "*.nix" -exec nixfmt --check {} +'
        continue-on-error: true
