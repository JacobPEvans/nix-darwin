# Reusable: Nix Validate (Linux)
# Called by ci-gate.yml and ci-validate.yml
name: _nix-validate

on:
  workflow_call:

# Performance: Cancel in-progress validation when new commits arrive
concurrency:
  group: nix-validate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Performance: Install Nix with built-in caching
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      # Performance: Cache Nix store for faster validation
      - name: Cache Nix Store
        uses: actions/cache@v5
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-linux-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-linux-${{ runner.os }}-

      - name: Lint flake.lock
        uses: DeterminateSystems/flake-checker-action@main
        with:
          nixpkgs-keys: nixpkgs

      - name: Check flake
        run: nix flake check --no-build
