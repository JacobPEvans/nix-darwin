# Reusable: Nix Validate (Linux)
# Called by ci-gate.yml and ci-validate.yml
#
# Runs quality checks (formatting, linting, dead code) on the cheaper Linux runner.
# Full nix flake check with builds â€” runs in parallel with macOS build.
name: _nix-validate

on:
  workflow_call:

# Performance: Cancel in-progress validation when new commits arrive
concurrency:
  group: nix-validate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Performance: Install Nix with CI-optimized settings
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            max-jobs = auto
            cores = 0
            http-connections = 50
            connect-timeout = 5
            stalled-download-timeout = 10
            narinfo-cache-positive-ttl = 86400
            fallback = true

      # Performance: Restore Nix store from cache (fast bulk tarball)
      - name: Restore Nix Store Cache
        uses: actions/cache/restore@v5
        id: nix-cache
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-linux-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-linux-${{ runner.os }}-

      - name: Lint flake.lock
        uses: DeterminateSystems/flake-checker-action@main
        with:
          nixpkgs-keys: nixpkgs

      - name: Check flake
        run: nix flake check --print-build-logs

      # Performance: Save cache only on main push when key misses
      - name: Save Nix Store Cache
        if: github.event_name == 'push' && steps.nix-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-linux-${{ runner.os }}-${{ hashFiles('flake.lock') }}
