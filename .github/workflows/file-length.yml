# File Size Check - Enforce documentation organization guidelines
# Uses file size (bytes) as proxy for token count.
# Limits: 8KB recommended, 16KB hard, 32KB extended, or exempt
name: File Size Check

on:
  pull_request:
    paths: ['**.md', '**.nix']

env:
  EXTENDED: "CLAUDE ANTHROPIC-ECOSYSTEM TROUBLESHOOTING"
  EXEMPT: "RUNBOOK copilot-permissions-allow copilot-permissions-ask gemini-permissions-allow gemini-permissions-ask"

jobs:
  check:
    name: Check File Sizes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check file sizes
        run: |
          ERRORS=0
          for f in $(find . \( -name "*.md" -o -name "*.nix" \) -not -path "./.git/*" | sort); do
            base=$(basename "$f" | sed 's/\.[^.]*$//')
            size=$(wc -c < "$f" | tr -d ' ')
            kb=$((size / 1024))

            # Determine limit: exempt (skip) / extended (32KB) / standard (16KB)
            if echo "${{ env.EXEMPT }}" | grep -qw "$base"; then continue; fi
            if echo "${{ env.EXTENDED }}" | grep -qw "$base"; then limit=32768; else limit=16384; fi

            if [ "$size" -gt "$limit" ]; then
              echo "::error file=$f::$f is ${kb}KB (exceeds $((limit/1024))KB limit)"
              ERRORS=$((ERRORS + 1))
            elif [ "$size" -gt 8192 ]; then
              echo "::warning file=$f::$f is ${kb}KB (exceeds 8KB recommended)"
            fi
          done
          [ $ERRORS -eq 0 ] || exit 1
