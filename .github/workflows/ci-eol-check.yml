# NixOS EOL Check - Blocking validation (standalone)
#
# Validates that the current stable NixOS version hasn't reached end-of-life.
# FAILS the build if the version has passed its EOL date.
# Runs on every push to catch version updates early.

name: NixOS EOL Check

on:
  push:
    branches: ['**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  eol-check:
    name: Check NixOS Version EOL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify NixOS version is supported
        run: |
          # Extract stable version from lib/versions.nix
          STABLE_VERSION=$(grep -oP 'stableVersion\s*=\s*"\K[^"]+' lib/versions.nix)

          if [ -z "$STABLE_VERSION" ]; then
            echo "::error file=lib/versions.nix::Could not extract stableVersion from lib/versions.nix"
            exit 1
          fi

          echo "Current stable version: $STABLE_VERSION"

          # EOL lookup table (embedded in workflow, no external dependencies)
          # Format: VERSION|EOL_DATE
          declare -A EOL_DATES=(
            ["24.05"]="2025-06-30"
            ["24.11"]="2025-12-31"
            ["25.05"]="2026-06-30"
            ["25.11"]="2026-12-31"
          )

          # Get EOL date for current version
          EOL_DATE="${EOL_DATES[$STABLE_VERSION]}"

          if [ -z "$EOL_DATE" ]; then
            echo "::warning file=lib/versions.nix::NixOS version $STABLE_VERSION not found in EOL table. Please update the workflow."
            echo "Known versions: ${!EOL_DATES[@]}"
            exit 0  # Don't fail on unknown versions, just warn
          fi

          echo "EOL date for NixOS $STABLE_VERSION: $EOL_DATE"

          # Compare current date with EOL date
          TODAY=$(date +%Y-%m-%d)
          echo "Today's date: $TODAY"

          # String comparison works for ISO 8601 dates (YYYY-MM-DD)
          if [[ "$TODAY" > "$EOL_DATE" ]]; then
            echo "::error file=lib/versions.nix,line=7::NixOS $STABLE_VERSION reached end-of-life on $EOL_DATE. Update lib/versions.nix to a supported version."
            echo ""
            echo "Available versions:"
            for version in "${!EOL_DATES[@]}"; do
              eol="${EOL_DATES[$version]}"
              if [[ ! "$TODAY" > "$eol" ]]; then
                echo "  - $version (supported until $eol)"
              fi
            done | sort
            exit 1
          fi

          echo "âœ“ NixOS $STABLE_VERSION is supported (EOL: $EOL_DATE)"
