# Reusable: Nix Build (macOS)
# Called by ci-gate.yml and ci-nix.yml
#
# Cache strategy: Download cache on all runs, upload only on push to main
# This speeds up PR CI by skipping the slow cache upload post-action
name: _nix-build

on:
  workflow_call:
    inputs:
      # Allow callers to disable cache upload (e.g., on PRs)
      # Values: "enabled" (default), "disabled", "no-preference"
      use-gha-cache:
        description: 'GHA cache mode - set to "disabled" on PRs to skip slow upload'
        type: string
        default: 'enabled'

# Performance: Cancel in-progress builds when new commits arrive
concurrency:
  group: nix-build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Performance: Install Nix with built-in caching
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      # Performance: GitHub Actions cache for Nix store paths
      # Reduces build time by caching derivations across workflow runs
      - name: Cache Nix Store
        uses: actions/cache@v5
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-macos-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-macos-${{ runner.os }}-

      - name: Determinate Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false
          # Pass through caller's cache mode setting
          # "disabled" on PRs skips slow upload, "enabled" on main keeps cache fresh
          use-gha-cache: ${{ inputs.use-gha-cache }}

      - name: Nix quality checks (DRY via flake.nix)
        # Single source of truth with pre-commit hooks
        # Runs: formatting (nixfmt-rfc-style), linting (statix), dead code (deadnix)
        run: nix flake check --print-build-logs

      - name: Build Home Manager
        run: ./scripts/workflows/build-hm.sh result-hm

      - name: Verify Nix Symlinks
        run: ./scripts/workflows/verify-symlinks.sh result-hm/home-files
