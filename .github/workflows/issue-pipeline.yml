name: Issue Pipeline

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to resolve (must already be labeled)"
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  triage:
    if: github.event_name == 'issues' && github.event.sender.type != 'Bot'
    uses: JacobPEvans/ai-workflows/.github/workflows/issue-triage.yml@v0.2.2
    secrets: inherit

  # Bridge job: always() on reusable workflow jobs with needs on another
  # reusable workflow is not evaluated by GitHub Actions. This regular job
  # ensures the resolve job runs when triage is skipped (workflow_dispatch).
  gate:
    needs: triage
    if: always() && (github.event_name == 'workflow_dispatch' || github.event.sender.type != 'Bot') && (needs.triage.result == 'success' || needs.triage.result == 'skipped')
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - run: 'true'

  resolve:
    needs: gate
    # success() checks the ENTIRE needs graph (triage→gate→resolve).
    # Triage is skipped on workflow_dispatch, so success() returns false.
    # Explicitly check only the direct dependency.
    if: always() && needs.gate.result == 'success'
    uses: JacobPEvans/ai-workflows/.github/workflows/issue-resolver.yml@v0.2.2
    secrets: inherit
    with:
      repo_context: "NixOS/nix-darwin system configuration using flakes"
      issue_number: ${{ github.event.inputs.issue_number || 0 }}
      extra_tools: "Bash(nix:*)"
