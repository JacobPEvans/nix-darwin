# Auto-Claude CI Validation
#
# Validates auto-claude shell scripts and orchestrator prompt
# on PRs that modify auto-claude related files.

name: Auto-Claude CI

on:
  pull_request:
    paths:
      - 'modules/home-manager/ai-cli/claude/auto-claude*.sh'
      - 'modules/home-manager/ai-cli/claude/auto-claude*.nix'
      - 'modules/home-manager/ai-cli/claude/auto-claude*.py'
      - 'modules/home-manager/ai-cli/claude/orchestrator-prompt.txt'
      - '.github/workflows/ci-auto-claude.yml'

permissions:
  contents: read

jobs:
  validate:
    name: Validate Auto-Claude
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate shell script syntax (zsh)
        run: |
          echo "Validating auto-claude shell scripts..."
          for script in modules/home-manager/ai-cli/claude/auto-claude*.sh; do
            if [ -f "$script" ]; then
              echo "  Checking: $script"
              zsh -n "$script"
            fi
          done
          echo "All shell scripts passed syntax validation"

      - name: Validate orchestrator prompt structure
        run: |
          PROMPT_FILE="modules/home-manager/ai-cli/claude/orchestrator-prompt.txt"

          echo "Validating orchestrator prompt: $PROMPT_FILE"

          # Check file exists and is not empty
          if [ ! -s "$PROMPT_FILE" ]; then
            echo "ERROR: Orchestrator prompt file is missing or empty"
            exit 1
          fi

          # Check required sections
          echo "  Checking for IDENTITY section..."
          if ! grep -q "IDENTITY" "$PROMPT_FILE"; then
            echo "ERROR: Missing IDENTITY section in orchestrator prompt"
            exit 1
          fi

          echo "  Checking for CORE LOOP section..."
          if ! grep -q "CORE LOOP" "$PROMPT_FILE"; then
            echo "ERROR: Missing CORE LOOP section in orchestrator prompt"
            exit 1
          fi

          echo "  Checking for SUB-AGENT section..."
          if ! grep -q "SUB-AGENT" "$PROMPT_FILE"; then
            echo "ERROR: Missing SUB-AGENT section in orchestrator prompt"
            exit 1
          fi

          echo "  Checking for NOTIFICATION section..."
          if ! grep -q "NOTIFICATION" "$PROMPT_FILE"; then
            echo "ERROR: Missing NOTIFICATION section in orchestrator prompt"
            exit 1
          fi

          echo "Orchestrator prompt validation passed"

      - name: Check for required dependencies in scripts
        run: |
          echo "Checking auto-claude.sh for required dependency checks..."

          SCRIPT="modules/home-manager/ai-cli/claude/auto-claude.sh"
          if [ ! -f "$SCRIPT" ]; then
            echo "WARNING: auto-claude.sh not found, skipping dependency check"
            exit 0
          fi

          # Check for jq dependency (used in control file handling)
          if grep -q "jq" "$SCRIPT"; then
            echo "  jq dependency found (used for control file handling)"
          fi

          # Check for claude CLI check
          if grep -q "command -v claude" "$SCRIPT"; then
            echo "  Claude CLI availability check found"
          else
            echo "WARNING: Script may not check for claude CLI availability"
          fi

          # Check for gh CLI check
          if grep -q "command -v gh" "$SCRIPT"; then
            echo "  GitHub CLI availability check found"
          fi

          echo "Dependency checks complete"
