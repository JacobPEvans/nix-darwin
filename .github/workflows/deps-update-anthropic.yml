# Anthropic Repositories Fast-Track Updates
# Daily selective updates for fast-moving Anthropic repos
# Updates: claude-code-plugins, claude-cookbooks, claude-plugins-official, anthropic-skills
name: Update Anthropic Repos

on:
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
  workflow_dispatch: {} # Manual trigger

jobs:
  update:
    name: Update Anthropic Flake Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Update Anthropic inputs
        run: |
          # Update each Anthropic input individually
          # This creates a single commit with all changes

          echo "Updating Anthropic flake inputs..."

          nix flake lock \
            --update-input claude-code-plugins \
            --update-input claude-cookbooks \
            --update-input claude-plugins-official \
            --update-input anthropic-skills

          echo "Anthropic inputs updated successfully"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet flake.lock; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in flake.lock"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in flake.lock"
          fi

      - name: Generate diff summary
        if: steps.check-changes.outputs.has_changes == 'true'
        id: diff-summary
        run: |
          # Extract changed inputs from flake.lock
          CHANGES=$(git diff flake.lock | grep -E '^\+.*"(claude-code-plugins|claude-cookbooks|claude-plugins-official|anthropic-skills)"' || echo "")

          if [[ -n "$CHANGES" ]]; then
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "Updated Anthropic repositories:" >> $GITHUB_OUTPUT
            echo "$CHANGES" | sed 's/^+/  -/' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=Minor dependency updates" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update Anthropic repositories

            Daily fast-track update for Anthropic flake inputs:
            - claude-code-plugins (anthropic/claude-code)
            - claude-cookbooks (anthropic/claude-cookbooks)
            - claude-plugins-official (anthropic/claude-plugins-official)
            - anthropic-skills (anthropic/skills)

            This is an automated daily update to keep Anthropic tooling current.

          branch: deps/anthropic-daily
          delete-branch: true
          title: "chore(deps): update Anthropic repositories"
          body: |
            ## Anthropic Repositories Daily Update

            This PR updates Anthropic-related flake inputs to their latest versions.

            ### Updated Inputs

            ${{ steps.diff-summary.outputs.summary }}

            ### Review Process

            - âœ… CI validates flake structure and builds
            - ðŸ¤– AI review workflow analyzes changes for risk
            - ðŸš€ Low-risk updates may auto-merge; others require human review

            ### Updated Repositories

            - **claude-code-plugins**: Slash commands, agents, and Claude Code core
            - **claude-cookbooks**: Patterns, examples, and cookbook content
            - **claude-plugins-official**: Curated plugin directory
            - **anthropic-skills**: Public skills repository

            ---

            ðŸ¤– Generated by [Anthropic Fast-Track Workflow](.github/workflows/deps-update-anthropic.yml)

          labels: |
            dependencies
            anthropic
          assignees: ${{ github.repository_owner }}

      - name: Report no changes
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "::notice::No changes detected. Anthropic inputs are already up to date."
