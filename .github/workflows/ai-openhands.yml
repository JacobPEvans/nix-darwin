# OpenHands AI Agent Workflow
#
# Autonomous AI agent that handles GitHub issues labeled with 'ai:openhands'
# Uses OpenHands (formerly OpenDevin) in headless mode to:
# - Read issue descriptions
# - Analyze codebase
# - Implement fixes/features
# - Create pull requests
#
# PREREQUISITES (human setup required):
# 1. Add ANTHROPIC_API_KEY to repository secrets
# 2. Enable "Allow GitHub Actions to create and approve pull requests"
#    (Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions)
#
# Reference: https://github.com/marketplace/actions/openhands-ai-action

name: OpenHands AI Agent

on:
  issues:
    types: [labeled]

jobs:
  openhands-agent:
    name: Run OpenHands Agent
    # Only run when 'ai:openhands' label is added
    if: github.event.label.name == 'ai:openhands'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue details
        id: issue
        run: |
          echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          # Escape multiline body for use in prompt
          BODY=$(cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run OpenHands Agent
        uses: xinbenlv/openhands-action@v1.0.1-rc3
        with:
          prompt: |
            You are an autonomous AI agent working on issue #${{ steps.issue.outputs.number }}.

            Issue Title: ${{ steps.issue.outputs.title }}

            Issue Description:
            ${{ steps.issue.outputs.body }}

            Instructions:
            1. Analyze the issue and understand what needs to be done
            2. Explore the codebase to understand the structure
            3. Implement the necessary changes
            4. Create a new branch named 'openhands/issue-${{ steps.issue.outputs.number }}'
            5. Commit your changes with a clear commit message
            6. The workflow will create a PR automatically

            Important:
            - This is a Nix configuration repository (nix-darwin + home-manager)
            - Follow existing code patterns and style
            - Run 'nix flake check' to validate changes
            - Keep changes focused on the issue
          llm_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          llm_model: "anthropic/claude-sonnet-4-20250514"
          log_all_events: "true"

      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: openhands/issue-${{ github.event.issue.number }}
          title: "fix: Address issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          body: |
            ## Summary

            This PR was automatically generated by OpenHands AI Agent to address:
            - Issue: #${{ github.event.issue.number }}
            - Title: ${{ github.event.issue.title }}

            ## Changes

            [OpenHands analyzed the issue and implemented the following changes]

            ## Test Plan

            - [ ] Run `nix flake check`
            - [ ] Review changes match issue requirements
            - [ ] Verify no unintended side effects

            ---
            ü§ñ Generated by [OpenHands AI Action](https://github.com/marketplace/actions/openhands-ai-action)
          labels: |
            automated
            ai:openhands
          reviewers: JacobPEvans

      - name: Comment on Issue
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ OpenHands AI Agent has analyzed this issue and created a pull request. Please review the changes.'
            })

      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå OpenHands AI Agent encountered an error while processing this issue. Please check the workflow logs or handle manually.'
            })
