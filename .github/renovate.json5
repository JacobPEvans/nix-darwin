// Renovate Bot Configuration
// Automated dependency updates for Nix flakes and npm packages
//
// Documentation: https://docs.renovatebot.com/configuration-options/
// Schema: https://docs.renovatebot.com/config-presets/

{
  // Base configuration presets
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":dependencyDashboard",
    ":semanticCommits",
    ":enablePreCommit"
  ],

  // Repository settings
  "timezone": "America/New_York",
  "labels": ["dependencies", "renovate"],
  "assignees": ["@JacobPEvans"],
  "reviewers": ["@JacobPEvans"],

  // Global automerge defaults (inherited by all packageRules except where overridden)
  "automerge": true,
  "automergeType": "pr",
  "automergeStrategy": "squash",

  // Nix flake support (native manager)
  "nix": {
    "enabled": true
  },

  // Custom regex managers for bunx wrappers in .nix files
  "customManagers": [
    {
      "customType": "regex",
      "description": "Detect bunx wrapper versions in ai-tools.nix",
      "fileMatch": ["^modules/home-manager/ai-cli/ai-tools\\.nix$"],
      "matchStrings": [
        // Pattern: bunx --bun @scope/package@version OR bunx --bun package@version
        // Handles both scoped (@scope/package) and unscoped packages
        // Version pattern: [0-9]+\\.[0-9]+\\.[0-9]+ matches X.Y.Z semver format
        // - Pre-release: (?:-[a-zA-Z0-9.-]+)? matches -beta.1, -alpha, -rc.1, etc.
        // - Build metadata: (?:\\+[a-zA-Z0-9.-]+)? matches +build.1, +meta, etc.
        // Examples matched: 1.0.0, 1.2.3-beta.1, 2.0.0-rc.1+build.123
        "bunx\\s+(?:--bun\\s+)?(?<depName>@?(?:[a-zA-Z0-9_.-]+/)?[a-zA-Z0-9_.-]+)@(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+(?:-[a-zA-Z0-9.-]+)?(?:\\+[a-zA-Z0-9.-]+)?)"
      ],
      "datasourceTemplate": "npm",
      "versioningTemplate": "npm"
    }
  ],

  // Package grouping and scheduling strategy
  "packageRules": [
    // GROUP 1: Critical infrastructure (Daily 7am with automerge)
    // Note: matchPackageNames uses GitHub repo paths (owner/repo), not flake input names
    {
      "description": "Critical system inputs - daily updates at 7am",
      "matchDatasources": ["github-tags", "github-releases"],
      "matchPackageNames": [
        "NixOS/nixpkgs",
        "nix-darwin/nix-darwin",
        "nix-community/home-manager",
        "JacobPEvans/ai-assistant-instructions"
      ],
      "groupName": "critical-infrastructure",
      "schedule": ["after 7am every day"],
      "minimumReleaseAge": "1 day" // Wait 1 day for bug reports before merging
    },

    // GROUP 2: AI tools (Daily 7am)
    // Note: matchPackagePatterns uses GitHub repo patterns, not flake input names
    {
      "description": "AI-focused flake inputs - daily updates at 7am",
      "matchPackagePatterns": [
        "anthropics/",
        "buildermethods/agent-os",
        "numtide/llm-agents",
        "obra/superpowers",
        "JacobPEvans/claude-code-plugins"
      ],
      "groupName": "ai-tools",
      "schedule": ["after 7am every day"]
    },

    // GROUP 3: npm packages (bunx wrappers) - Weekly Monday 7am
    {
      "description": "Bunx wrapper npm packages - weekly updates at 7am Monday",
      "matchDatasources": ["npm"],
      "matchFileNames": ["modules/home-manager/ai-cli/ai-tools.nix"],
      "groupName": "npm-wrappers",
      "schedule": ["after 7am on Monday"],
      "minimumReleaseAge": "3 days" // Let npm packages stabilize before merging
    },

    // GROUP 4: GitHub Actions - Weekly Monday 7am
    {
      "description": "GitHub Actions updates - weekly at 7am Monday",
      "matchManagers": ["github-actions"],
      "groupName": "github-actions",
      "schedule": ["after 7am on Monday"],
      "automergeRequireAllStatusChecks": true
    },

    // SPECIAL: Node.js LTS tracking (no latest/current versions)
    // NOTE: Currently inactive - Node.js is managed via nixpkgs flake input (not npm/github-releases)
    // This rule would only apply if we tracked Node.js directly from npm registry or GitHub releases
    // To enforce Node.js LTS versions, update nixpkgs to a version that includes the desired LTS
    {
      "description": "Node.js - track LTS versions only (inactive - see comment above)",
      "matchDatasources": ["github-releases", "npm"],
      "matchPackageNames": ["nodejs", "node"],
      "allowedVersions": "20.x || 22.x",
      // TODO(2026-10): Review Node.js LTS versions
      // - Node.js 24.x becomes LTS in October 2026
      // - Update allowedVersions to "20.x || 22.x || 24.x" when LTS is confirmed
      // - Create GitHub issue to track this reminder
      "automerge": false, // Always review Node.js updates
      "enabled": false // Disabled: Node.js managed via nixpkgs flake, not direct npm/github-releases
    },

    // Override for major updates (require human review)
    {
      "description": "Never auto-merge major updates (X.0.0) - require human review",
      "matchUpdateTypes": ["major"],
      "automerge": false
    }
  ],

  // Commit message formatting
  "commitMessagePrefix": "chore(deps): ",
  "commitMessageAction": "update",
  "commitMessageTopic": "{{{depName}}}",
  "commitMessageExtra": "to {{{newVersion}}}",
  "commitBody": "Co-Authored-By: Renovate Bot <bot@renovateapp.com>",

  // PR configuration
  "prConcurrentLimit": 3, // Max 3 PRs open at once (default: 0 = unlimited)
  "prCreation": "immediate", // Create PR as soon as update detected
  "prHourlyLimit": 1, // Max 1 new PR per hour (prevent spam)

  // Branch naming
  "branchPrefix": "chore/renovate/",
  "branchConcurrentLimit": 5,

  // Dependency dashboard (GitHub issue)
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Dependency Dashboard (Renovate)",
  "dependencyDashboardHeader": "This issue tracks pending dependency updates managed by Renovate Bot.",
  "dependencyDashboardFooter": "For manual updates, use: `nix flake update` or trigger the deps-update-flake.yml workflow.",

  // Post-upgrade tasks (run after updates)
  "postUpgradeTasks": {
    "commands": [
      "nix flake check --no-build"
    ],
    "fileFilters": [
      "flake.lock"
    ],
    "executionMode": "branch"
  },

  // Vulnerability alerts
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security"],
    "automerge": true,
    "automergeRequireAllStatusChecks": true
  },

  // Ignore patterns
  "ignoreDeps": [
    // Add packages to ignore here (e.g., broken packages, intentional pins)
    // Example: "superpowers-marketplace" // Archived, pinned intentionally
  ],

  // Platform-specific settings
  "platformAutomerge": true, // Use GitHub's auto-merge feature when enabled
  "platformCommit": true // Use GitHub API for commits (enables signing)
}
