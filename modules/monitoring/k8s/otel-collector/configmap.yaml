apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
  labels:
    app: otel-collector
data:
  otel-collector-config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # File log receiver for Claude logs
      filelog:
        include:
          - /var/log/claude/*.jsonl
          - /var/log/claude/events.jsonl
        start_at: end
        operators:
          - type: json_parser
            timestamp:
              parse_from: attributes.timestamp
              layout: '%Y-%m-%dT%H:%M:%SZ'

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024

      # Add resource attributes
      resource:
        attributes:
          - key: service.name
            value: claude-code
            action: upsert
          - key: deployment.environment
            value: local
            action: upsert

    exporters:
      # Forward to Cribl Edge OTEL endpoint
      otlphttp:
        endpoint: http://cribl-edge:9420

      # Debug logging (replaced deprecated 'logging' exporter)
      debug:
        verbosity: normal
        sampling_initial: 5
        sampling_thereafter: 200

      # Send to Splunk HEC
      splunk_hec:
        token: "${SPLUNK_HEC_TOKEN}"
        endpoint: http://splunk:8088/services/collector
        source: otel
        sourcetype: otel
        index: claude

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlphttp, debug]
        metrics:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlphttp, debug]
        logs:
          receivers: [otlp, filelog]
          processors: [batch, resource]
          exporters: [otlphttp, splunk_hec, debug]
