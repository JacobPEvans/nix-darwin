# Powerline Theme - Claude Code Statusline
#
# Multi-line statusline with powerline-style graphics powered by claude-powerline.
# Builds the package from source using Nix for reproducible, hermetic deployment.
#
# Features:
# - Multi-line layout (4 lines by default)
# - 5-hour billing block tracking with reset timer
# - Session and daily cost tracking
# - Full directory path display
# - Git info (branch, SHA, stash count)
# - Context window usage
# - 6 customizable color themes
#
# Repository: https://github.com/Owloops/claude-powerline
{
  config,
  lib,
  pkgs,
  claude-powerline,
  ...
}:

let
  cfg = config.programs.claudeStatusline;
  powerlineStyle = cfg.powerline.style;
  homeDir = config.home.homeDirectory;

  # Build claude-powerline as a Nix package from the flake input
  # This ensures reproducible builds without runtime network dependencies
  claude-powerline-pkg = pkgs.buildNpmPackage {
    pname = "claude-powerline";
    version = "1.13.2";
    src = claude-powerline;

    # Hash of npm dependencies (verified against package-lock.json)
    # Generated by setting to lib.fakeHash and extracting from build error
    npmDepsHash = "sha256-GT+iSNRlV0P3TUFC6jwvexxdrpPUlpPZg8PKRyI9+uc=";

    # TypeScript build process (runs tsup to generate dist/)
    npmBuild = "npm run build";

    meta = with lib; {
      description = "Beautiful powerline statusline for Claude Code";
      homepage = "https://github.com/Owloops/claude-powerline";
      license = licenses.mit;
      platforms = platforms.all;
      mainProgram = "claude-powerline";
    };
  };

  # Map our style names to claude-powerline theme names
  themeMap = {
    "default" = "dark";
    "minimal" = "dark";
    "rainbow" = "dark";
    "gruvbox" = "gruvbox";
    "dracula" = "dark"; # closest match
    "nord" = "nord";
  };
  themeName = themeMap.${powerlineStyle} or "dark";

  # Rich multi-line configuration for claude-powerline
  # Displays: directory, git, model, session costs, 5-hour block, daily usage, context
  powerlineConfig = {
    theme = themeName;
    style = "powerline";
    charset = "unicode";

    display = {
      lines = [
        # Line 1: Directory (full path), Git info, Model
        {
          segments = {
            directory = {
              enabled = true;
              style = "full"; # Show full path from ~
            };
            git = {
              enabled = true;
              showSha = true;
              showStash = true;
              showUpstream = true;
            };
            model = {
              enabled = true;
            };
          };
        }
        # Line 2: Session cost, 5-hour block, Daily usage
        {
          segments = {
            session = {
              enabled = true;
              type = "breakdown"; # Show input/output split
            };
            block = {
              enabled = true;
              type = "weighted"; # Account for model multipliers
              burnType = "cost"; # Show burn rate
            };
            today = {
              enabled = true;
              type = "breakdown";
            };
          };
        }
        # Line 3: Context window, Metrics
        {
          segments = {
            context = {
              enabled = true;
            };
            metrics = {
              enabled = true;
            };
            version = {
              enabled = true;
            };
          };
        }
      ];
    };

    # Budget warnings at 80%
    budget = {
      session = {
        amount = 10.0;
        warningThreshold = 80;
      };
      today = {
        amount = 25.0;
        warningThreshold = 80;
      };
      block = {
        amount = 15.0;
        type = "cost";
        warningThreshold = 80;
      };
    };
  };

  # Write config to JSON file
  configFile = pkgs.writeText "claude-powerline.json" (builtins.toJSON powerlineConfig);

in
{
  config = lib.mkIf (cfg.enable && cfg.theme == "powerline") {
    # Use ONLY the script option with actual content
    # settings.nix will:
    #   1. Create ~/.claude/statusline-command.sh with this content
    #   2. Add statusLine to settings.json pointing to that script
    # DO NOT also use home.file - that causes duplicate file creation = fork bomb!
    programs.claude.statusLine = {
      enable = true;
      script = ''
        #!/usr/bin/env bash
        # Claude Powerline statusline wrapper
        # Rich multi-line display with cost tracking
        ${claude-powerline-pkg}/bin/claude-powerline --config=${configFile} "$@"
      '';
    };
  };
}
